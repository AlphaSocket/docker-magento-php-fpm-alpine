#!/bin/sh
#
# MAGENTO PHP SETUP
#
# PHP-FPM on ALPINE
#

# exit if a command fails
set -e

source /usr/local/envvars

# Install dependencies for compile
apk --no-cache add --virtual .build-dependencies \
    m4 perl autoconf libmagic file libgcc libstdc++ binutils-libs binutils gmp libgomp libatomic mpfr3 gcc libc-dev g++ make re2c

#
# GD
#
if [ $PHP_INSTALL_EXTENTSION_GD = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add freetype libpng libjpeg-turbo freetype-dev libpng-dev libjpeg-turbo-dev musl musl-dev
    
    # Compiling gd
    docker-php-ext-configure gd \
        --with-gd \
        --with-freetype-dir=/usr/include/ \
        --with-png-dir=/usr/include/ \
        --with-jpeg-dir=/usr/include/
    
    # Install
    docker-php-ext-install gd
fi

#
# ICONV
#
if [ $PHP_INSTALL_EXTENTSION_ICONV = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add musl musl-dev
    # Install
    docker-php-ext-install iconv
fi

#
# OPCACHE
#
if [ $PHP_INSTALL_EXTENTSION_OPCACHE = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add musl musl-dev
    # Install
    docker-php-ext-install opcache
fi

#
# READLINE
#
if [ $PHP_INSTALL_EXTENTSION_READLINE = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add musl-dev libedit-dev
    # Install
    docker-php-ext-install readline
fi

#
# SOAP
#
if [ $PHP_INSTALL_EXTENTSION_SOAP = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add libxml2-dev
    # Install
    docker-php-ext-install soap
fi

#
# XML
#
if [ $PHP_INSTALL_EXTENTSION_READLINE = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add libxml2-dev
    # Install
    docker-php-ext-install xml
fi

#
# XML
#
if [ $PHP_INSTALL_EXTENTSION_MYSQLI = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add libxml2-dev
    # Install
    docker-php-ext-install mysqli
fi

#
# CURL
#
if [ $PHP_INSTALL_EXTENTSION_CURL = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add curl-dev
    # Install
    docker-php-ext-install curl
fi

#
# JSON
#
if [ $PHP_INSTALL_EXTENTSION_JSON = $TRUE_KEY ];
then
    # Install
    docker-php-ext-install json
fi

#
# MCRYPT
#
if [ $PHP_INSTALL_EXTENTSION_MCRYPT = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add libmcrypt-dev libltdl
    # Install
    docker-php-ext-install mcrypt
fi

#
# MBSTRING
#
if [ $PHP_INSTALL_EXTENTSION_MBSTRING = $TRUE_KEY ];
then
    # Install
    docker-php-ext-install mbstring
fi

#
# SODIUM
#
if [ $PHP_INSTALL_EXTENTSION_SODIUM = $TRUE_KEY ];
then
    # Dependencies
    apk --no-cache add libsodium-dev
    # Install
    docker-php-ext-install sodium
fi

#
# ZIP
#
if [ $PHP_INSTALL_EXTENTSION_ZIP = $TRUE_KEY ];
then
    apk --no-cache add zlib
    # Install
    docker-php-ext-install zip
fi

#
# REDIS
#
if [ $PHP_INSTALL_EXTENTSION_REDIS = $TRUE_KEY ];
then
    # Install
    pecl install redis
fi


#
# XDEBUG
#
if [ $PHP_INSTALL_EXTENTSION_XDEBUG = $TRUE_KEY ];
then
    # Install
    pecl install xdebug
fi

# Removing unused binaries
apk del .build-dependencies